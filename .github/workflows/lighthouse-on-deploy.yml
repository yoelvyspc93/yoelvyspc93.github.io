name: Lighthouse Report (on deploy)

on:
  workflow_run:
    workflows: ['Deploy Astro to GitHub Pages']
    types: [completed]

permissions:
  contents: read

concurrency:
  group: lighthouse-pages
  cancel-in-progress: true

jobs:
  lighthouse:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: yarn

      - name: Install
        run: yarn install --frozen-lockfile

      - name: Resolve GitHub Pages URL
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          OWNER="${{ github.repository_owner }}"
          REPO="$(echo "${{ github.repository }}" | cut -d/ -f2)"

          URL=$(gh api "repos/${OWNER}/${REPO}/pages" --jq '.html_url' 2>/dev/null || echo "")
          if [ -z "$URL" ] || [ "$URL" = "null" ]; then
            echo "Could not resolve GitHub Pages URL. Skipping."
            exit 0
          fi

          echo "PAGES_URL=${URL}" >> $GITHUB_ENV
          echo "Resolved Pages URL: ${URL}"

      - name: Wait for Pages to be ready
        run: |
          if [ -z "${PAGES_URL}" ]; then
            echo "No PAGES_URL found; skipping."
            exit 0
          fi

          for i in {1..60}; do
            if curl -sSfL "${PAGES_URL}" > /dev/null; then
              echo "Pages is reachable."
              exit 0
            fi
            echo "Waiting for Pages... (${i}/60)"
            sleep 5
          done

          echo "Pages did not become reachable in time. Skipping."
          exit 0

      - name: Create LHCI configs (mobile & desktop)
        run: |
          node - <<'EOF'
          const fs = require('fs')

          const base = JSON.parse(fs.readFileSync('lighthouserc.json', 'utf8'))

          const common = {
            ci: {
              collect: {
                ...base.ci.collect,
                settings: {
                  ...(base.ci.collect?.settings ?? {}),
                  onlyCategories: ['performance', 'accessibility', 'best-practices', 'seo']
                }
              }
            }
          }

          const desktopCfg = JSON.parse(JSON.stringify(common))
          desktopCfg.ci.collect.settings.preset = 'desktop'
          desktopCfg.ci.upload = { target: 'filesystem', outputDir: './lighthouse-report/desktop' }

          const mobileCfg = JSON.parse(JSON.stringify(common))
          mobileCfg.ci.collect.settings.formFactor = 'mobile'
          mobileCfg.ci.collect.settings.screenEmulation = {
            mobile: true,
            width: 412,
            height: 823,
            deviceScaleFactor: 2.625,
            disabled: false
          }
          mobileCfg.ci.upload = { target: 'filesystem', outputDir: './lighthouse-report/mobile' }

          fs.mkdirSync('lighthouse-report', { recursive: true })
          fs.writeFileSync('lighthouserc.mobile.json', JSON.stringify(mobileCfg, null, 2))
          fs.writeFileSync('lighthouserc.desktop.json', JSON.stringify(desktopCfg, null, 2))
          EOF

      - name: Run Lighthouse (mobile)
        run: |
          npx --yes @lhci/cli@0.13.x autorun \
            --config=./lighthouserc.mobile.json \
            --collect.url="${PAGES_URL}"

      - name: Run Lighthouse (desktop)
        if: always()
        run: |
          npx --yes @lhci/cli@0.13.x autorun \
            --config=./lighthouserc.desktop.json \
            --collect.url="${PAGES_URL}"

      - name: Evaluate Lighthouse thresholds
        if: always()
        run: |
          node - <<'EOF'
          const fs = require('fs')
          const path = require('path')

          function pickLhrJson(dir) {
            if (!fs.existsSync(dir)) return null
            const files = fs.readdirSync(dir).filter(f => f.endsWith('.json'))

            const lhr = files.find(f => /^lhr-.*\.json$/.test(f))
            if (lhr) return path.join(dir, lhr)

            for (const f of files) {
              try {
                const p = path.join(dir, f)
                const r = JSON.parse(fs.readFileSync(p, 'utf8'))
                if (r?.categories?.performance?.score != null) return p
              } catch {}
            }
            return null
          }

          function readScores(file) {
            const r = JSON.parse(fs.readFileSync(file, 'utf8'))
            const c = r.categories
            return {
              performance: Math.round(c.performance.score * 100),
              accessibility: Math.round(c.accessibility.score * 100),
              bestPractices: Math.round(c['best-practices'].score * 100),
              seo: Math.round(c.seo.score * 100)
            }
          }

          const minAveragePerformance = 97
          const mobileFile = pickLhrJson('./lighthouse-report/mobile')
          const desktopFile = pickLhrJson('./lighthouse-report/desktop')

          if (!mobileFile || !desktopFile) {
            console.log(`Could not locate LHR json reports (mobile: ${!!mobileFile}, desktop: ${!!desktopFile}).`)
            process.exit(1)
          }

          const m = readScores(mobileFile)
          const d = readScores(desktopFile)
          const avgPerf = Math.round((m.performance + d.performance) / 2)

          console.log(`Mobile  -> perf ${m.performance} | a11y ${m.accessibility} | bp ${m.bestPractices} | seo ${m.seo}`)
          console.log(`Desktop -> perf ${d.performance} | a11y ${d.accessibility} | bp ${d.bestPractices} | seo ${d.seo}`)
          console.log(`Average performance: ${avgPerf}`)

          const failures = []
          if (m.accessibility !== 100) failures.push(`Mobile accessibility must be 100 (found ${m.accessibility}).`)
          if (d.accessibility !== 100) failures.push(`Desktop accessibility must be 100 (found ${d.accessibility}).`)
          if (m.bestPractices !== 100) failures.push(`Mobile best-practices must be 100 (found ${m.bestPractices}).`)
          if (d.bestPractices !== 100) failures.push(`Desktop best-practices must be 100 (found ${d.bestPractices}).`)
          if (m.seo !== 100) failures.push(`Mobile SEO must be 100 (found ${m.seo}).`)
          if (d.seo !== 100) failures.push(`Desktop SEO must be 100 (found ${d.seo}).`)
          if (avgPerf < minAveragePerformance) {
            failures.push(`Average performance must be >= ${minAveragePerformance} (found ${avgPerf}).`)
          }

          if (failures.length > 0) {
            console.log('Threshold check failed:')
            failures.forEach(msg => console.log(`- ${msg}`))
            process.exit(1)
          }
          EOF

      - name: Lighthouse Summary
        if: always()
        run: |
          node - <<'EOF'
          const fs = require('fs')
          const path = require('path')

          function pickLhrJson(dir) {
            if (!fs.existsSync(dir)) return null
            const files = fs.readdirSync(dir).filter(f => f.endsWith('.json'))
            const lhr = files.find(f => /^lhr-.*\.json$/.test(f))
            if (lhr) return path.join(dir, lhr)

            for (const f of files) {
              try {
                const p = path.join(dir, f)
                const r = JSON.parse(fs.readFileSync(p, 'utf8'))
                if (r?.categories?.performance?.score != null) return p
              } catch {}
            }
            return null
          }

          function readScores(file) {
            const c = JSON.parse(fs.readFileSync(file, 'utf8')).categories
            return {
              performance: Math.round(c.performance.score * 100),
              accessibility: Math.round(c.accessibility.score * 100),
              bestPractices: Math.round(c['best-practices'].score * 100),
              seo: Math.round(c.seo.score * 100)
            }
          }

          const minAveragePerformance = 97
          const mFile = pickLhrJson('./lighthouse-report/mobile')
          const dFile = pickLhrJson('./lighthouse-report/desktop')

          if (!mFile || !dFile) {
            const missing = []
            if (!mFile) missing.push('mobile')
            if (!dFile) missing.push('desktop')
            fs.appendFileSync(
              process.env.GITHUB_STEP_SUMMARY,
              `## Lighthouse Report (Home)\n\nMissing report files: ${missing.join(', ')}.\nCheck previous step logs for details.\n`
            )
            process.exit(0)
          }

          const mobile = readScores(mFile)
          const desktop = readScores(dFile)
          const avgPerf = Math.round((mobile.performance + desktop.performance) / 2)

          const rules = [
            { rule: 'Mobile accessibility', expected: '100', found: `${mobile.accessibility}`, ok: mobile.accessibility === 100 },
            { rule: 'Desktop accessibility', expected: '100', found: `${desktop.accessibility}`, ok: desktop.accessibility === 100 },
            { rule: 'Mobile best-practices', expected: '100', found: `${mobile.bestPractices}`, ok: mobile.bestPractices === 100 },
            { rule: 'Desktop best-practices', expected: '100', found: `${desktop.bestPractices}`, ok: desktop.bestPractices === 100 },
            { rule: 'Mobile SEO', expected: '100', found: `${mobile.seo}`, ok: mobile.seo === 100 },
            { rule: 'Desktop SEO', expected: '100', found: `${desktop.seo}`, ok: desktop.seo === 100 },
            { rule: 'Average performance', expected: `>= ${minAveragePerformance}`, found: `${avgPerf}`, ok: avgPerf >= minAveragePerformance }
          ]

          const rulesTable = rules
            .map(r => `| ${r.rule} | ${r.expected} | ${r.found} | ${r.ok ? 'PASS' : 'FAIL'} |`)
            .join('\n')

          const summary = `
          ## Lighthouse Report (Home)

          | Category | Mobile | Desktop |
          |---------|--------|---------|
          | Performance | ${mobile.performance} | ${desktop.performance} |
          | Accessibility | ${mobile.accessibility} | ${desktop.accessibility} |
          | Best Practices | ${mobile.bestPractices} | ${desktop.bestPractices} |
          | SEO | ${mobile.seo} | ${desktop.seo} |

          **Average Performance:** ${avgPerf}

          ### Rules
          | Rule | Expected | Found | Status |
          |------|----------|-------|--------|
          ${rulesTable}
          `
          fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, summary)
          EOF

      - name: Upload Lighthouse report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-report
          path: lighthouse-report
          if-no-files-found: warn
