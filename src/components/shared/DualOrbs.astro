---
export interface Props {
	variant?: 'left' | 'center' | 'right'
	class?: string
}

const { variant = 'left', class: className = '' } = Astro.props

const pos = {
	left: {
		a: 'absolute -top-1/4 -right-1/2',
		b: 'relative top-1/4 right-1/2',
	},
	center: {
		a: 'absolute top-1/4 right-1/2',
		b: 'relative -top-1/4 -right-1/2',
	},
	right: {
		a: 'absolute -top-1/2 right-1/4',
		b: 'relative top-1/4 -right-1/2',
	},
}
---

<div
	class={`relative inline-block ${className}`}
	data-orb-pair
	data-variant={variant}
	style="
    --orb: 25vw;
    --orb2: 25vw;
  "
>
	<div
		class={`rounded-full bg-accent`}
		data-orb="base"
		style="width:var(--orb);height:var(--orb);"
	>
	</div>
	<div
		class={`rounded-full bg-primary ${pos[variant].a}`}
		data-orb="top"
		style="width:var(--orb2);height:var(--orb2);"
	>
	</div>
</div>

<script>
	import gsap from 'gsap'

	const prefersReduced =
		typeof window !== 'undefined' &&
		window.matchMedia?.('(prefers-reduced-motion: reduce)')?.matches

	const kill = () => {
		document.querySelectorAll('[data-orb-pair]').forEach((el) => {
			gsap.killTweensOf(el)
			gsap.killTweensOf(el.querySelector('[data-orb="base"]'))
			gsap.killTweensOf(el.querySelector('[data-orb="top"]'))
		})
	}

	const init = () => {
		if (prefersReduced) return

		document.querySelectorAll('[data-orb-pair]').forEach((el) => {
			const base = el.querySelector('[data-orb="base"]')
			const top = el.querySelector('[data-orb="top"]')
			if (!base || !top) return

			// evita duplicados si Astro re-hidrata/transiciona
			gsap.killTweensOf([base, top])

			const variant = el.getAttribute('data-variant') || 'left'
			const dir = variant === 'center' ? -1 : 1

			gsap.set([base, top], {
				transformOrigin: '50% 50%',
				willChange: 'transform',
			})

			// rotaci√≥n lenta continua
			gsap.to(base, {
				rotate: 360 * dir,
				duration: 60,
				ease: 'none',
				repeat: -1,
			})
			gsap.to(top, {
				rotate: -360 * dir,
				duration: 85,
				ease: 'none',
				repeat: -1,
			})

			// movimiento suave (drift)
			const tl = gsap.timeline({
				repeat: -1,
				yoyo: true,
				defaults: { ease: 'sine.inOut' },
			})

			tl.to([base, top], { y: -24, duration: 4 }, 0)
			tl.to(top, { x: 20 * dir, duration: 5 }, 0)
			tl.to(base, { x: -26 * dir, duration: 6 }, 0.5)
		})
	}

	// carga normal
	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', init, { once: true })
	} else {
		init()
	}

	// soporte Astro transitions
	document.addEventListener('astro:page-load', init)

	// cleanup antes de swap (evita animaciones duplicadas)
	document.addEventListener('astro:before-swap', kill)
</script>
