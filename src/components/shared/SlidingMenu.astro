---
import Button from '@/ui/Button.astro'

type Props = {
	data: {
		brand: string
		links: { label: string; href: string }[]
		cta: { label: string; href: string }
	}
}

const { links, cta } = Astro.props.data
---

<header class="fixed inset-x-0 top-0 z-50 lg:hidden" data-sliding-menu>
	<button
		type="button"
		class="fixed right-4 top-4 z-60 inline-flex size-14 items-center justify-center rounded-full border border-primary/10 bg-white/90 text-primary shadow-small backdrop-blur-sm transition-colors duration-300 hover:bg-primary hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-primary/60 sm:right-6 sm:top-6"
		aria-label="Toggle menu"
		aria-expanded="false"
		aria-controls="mobile-navigation-menu"
		data-menu-toggle
	>
		<span class="sr-only">Toggle menu</span>
		<div
			data-burger
			class="burger-icon relative h-[2px] w-5 bg-current transition-all duration-300
				before:absolute before:left-0 before:top-[-6px] before:h-[2px] before:w-5 before:bg-current before:content-[''] before:transition-all before:duration-300
				after:absolute after:left-0 after:top-[6px] after:h-[2px] after:w-[14px] after:bg-current after:content-[''] after:transition-all after:duration-300"
		>
		</div>
	</button>

	<div
		id="mobile-navigation-menu"
		class="fixed right-0 top-0 z-55 flex h-screen w-[460px] max-w-[100vw] items-stretch border-l border-primary/20 bg-surface-base text-black shadow-large pointer-events-none invisible"
		role="dialog"
		aria-modal="true"
		aria-label="Navigation menu"
		aria-hidden="true"
		data-menu-overlay
	>
		<div aria-hidden="true" class="pointer-events-none absolute inset-0"></div>

		<svg
			class="pointer-events-none absolute -left-[99px] top-0 h-full w-[100px]"
			style="fill: var(--color-surface-base)"
			xmlns="http://www.w3.org/2000/svg"
		>
			<path data-curve-path></path>
		</svg>

		<div
			class="relative z-10 flex w-full flex-col justify-between px-8 pb-10 pt-20 sm:px-10"
		>
			<nav data-menu-nav>
				<p
					class="mb-8 border-b border-black/10 pb-4 text-[10px] font-medium uppercase tracking-[0.16em] text-black/50"
				>
					Navigation
				</p>

				<ul class="m-0 flex list-none flex-col p-0">
					{
						links.map(({ label, href }, index) => (
							<li
								class="menu-link-item flex cursor-pointer items-center gap-4 border-b border-black/8 py-3 opacity-0 translate-x-6"
								data-index={index}
								data-href={href}
							>
								<span
									class="link-dot h-[6px] w-[6px] shrink-0 scale-0 rounded-full bg-primary transition-transform duration-300"
									style="transition-timing-function: cubic-bezier(0.34,1.56,0.64,1)"
								/>
								<a
									href={href}
									class="relative font-display text-[clamp(1.6rem,7vw,2.1rem)] leading-none tracking-[0.03em] text-black no-underline transition-colors duration-300
									   hover:text-primary"
									data-menu-link
								>
									{label}
								</a>
							</li>
						))
					}
				</ul>
			</nav>

			<div class="flex flex-col gap-4">
				<Button
					variant="primary"
					size="small"
					href={cta.href}
					external
					aria-label="Download my CV"
					class="w-full justify-center"
				>
					{cta.label}
				</Button>
			</div>
		</div>
	</div>
</header>

<style>
	[data-menu-overlay] {
		will-change: transform, opacity;
	}

	.burger-icon.is-active {
		background: transparent !important;
	}

	.burger-icon.is-active::before {
		top: 0 !important;
		width: 20px !important;
		transform: rotate(45deg);
	}

	.burger-icon.is-active::after {
		top: 0 !important;
		width: 20px !important;
		transform: rotate(-45deg);
	}

	.link-dot.dot-active {
		transform: scale(1) !important;
	}
</style>

<script>
	import { gsap } from 'gsap'
	;(() => {
		const menu = document.querySelector('[data-sliding-menu]')
		if (!(menu instanceof HTMLElement)) return

		const overlay = menu.querySelector('[data-menu-overlay]')
		const curvePath = menu.querySelector('[data-curve-path]')
		const toggleBtn = menu.querySelector('[data-menu-toggle]')
		const burger = menu.querySelector('[data-burger]')
		const menuNav = menu.querySelector('[data-menu-nav]')
		const linkItems = Array.from(
			menu.querySelectorAll<HTMLElement>('.menu-link-item'),
		)
		const footerLinks = Array.from(
			menu.querySelectorAll<HTMLElement>('.footer-link'),
		)
		const navLinks = Array.from(
			menu.querySelectorAll<HTMLAnchorElement>('[data-menu-link]'),
		)
		const desktopMq = window.matchMedia('(min-width: 64rem)')

		if (!(overlay instanceof HTMLElement)) return
		if (!(curvePath instanceof SVGPathElement)) return

		let isOpen = false

		const curveWidth = 100
		const flatPath = (h: number) =>
			`M100 0 L200 0 L200 ${h} L100 ${h} Q100 ${h / 2} 100 0`
		const curvedPath = (h: number) =>
			`M100 0 L200 0 L200 ${h} L100 ${h} Q-100 ${h / 2} 100 0`

		const lockBody = (lock: boolean) =>
			document.body.classList.toggle('overflow-hidden', lock)

		const defaultHref = linkItems[0]?.dataset.href || '#hero'
		const currentHref = window.location.hash || defaultHref
		const setActiveDot = (href: string) => {
			menu
				.querySelectorAll('.link-dot')
				.forEach((dot) => dot.classList.remove('dot-active'))
			linkItems.forEach((item) => {
				if (item.dataset.href === href)
					item.querySelector('.link-dot')?.classList.add('dot-active')
			})
		}

		linkItems.forEach((item) =>
			item.addEventListener('mouseenter', () =>
				setActiveDot(item.dataset.href || defaultHref),
			),
		)
		menuNav?.addEventListener('mouseleave', () => setActiveDot(currentHref))
		setActiveDot(currentHref)

		gsap.set(overlay, { xPercent: 100, x: curveWidth })
		gsap.set(curvePath, { attr: { d: curvedPath(window.innerHeight) } })
		gsap.set(linkItems, { opacity: 0, x: 18 })
		gsap.set(footerLinks, { opacity: 0, y: 8 })

		const timeline = gsap.timeline({
			paused: true,
			defaults: { ease: 'power3.out' },
			onReverseComplete: () => {
				overlay.setAttribute('aria-hidden', 'true')
				overlay.classList.add('pointer-events-none')
				overlay.classList.remove('pointer-events-auto')
				overlay.classList.add('invisible')
				lockBody(false)
			},
		})

		timeline
			.to(
				overlay,
				{
					xPercent: 0,
					x: 0,
					duration: 0.66,
					ease: 'power3.inOut',
				},
				0,
			)
			.to(
				curvePath,
				{
					attr: { d: () => flatPath(window.innerHeight) },
					duration: 0.66,
					ease: 'power3.inOut',
				},
				0,
			)
			.to(
				linkItems,
				{
					opacity: 1,
					x: 0,
					duration: 0.34,
					stagger: 0.04,
				},
				0.08,
			)
			.to(
				footerLinks,
				{
					opacity: 1,
					y: 0,
					duration: 0.28,
					stagger: 0.035,
				},
				0.16,
			)

		const openMenu = () => {
			if (isOpen) return
			isOpen = true
			overlay.setAttribute('aria-hidden', 'false')
			overlay.classList.remove('invisible')
			overlay.classList.remove('pointer-events-none')
			overlay.classList.add('pointer-events-auto')

			toggleBtn?.setAttribute('aria-expanded', 'true')
			burger?.classList.add('is-active')
			lockBody(true)

			timeline.invalidate()
			timeline.play()
		}

		const closeMenu = () => {
			if (!isOpen) return
			isOpen = false

			toggleBtn?.setAttribute('aria-expanded', 'false')
			burger?.classList.remove('is-active')
			timeline.reverse()
		}

		const onToggle = () => (isOpen ? closeMenu() : openMenu())
		const onKeydown = (e: KeyboardEvent) =>
			e.key === 'Escape' && isOpen && closeMenu()
		const onDesktopChange = (e: MediaQueryListEvent) =>
			e.matches && isOpen && closeMenu()
		const onResize = () => {
			if (!isOpen && timeline.progress() === 0) {
				curvePath.setAttribute('d', curvedPath(window.innerHeight))
				gsap.set(overlay, { xPercent: 100, x: curveWidth })
			}
			if (isOpen && timeline.progress() === 1) {
				curvePath.setAttribute('d', flatPath(window.innerHeight))
				gsap.set(overlay, { xPercent: 0, x: 0 })
			}
		}

		toggleBtn?.addEventListener('click', onToggle)
		document.addEventListener('keydown', onKeydown)
		desktopMq.addEventListener('change', onDesktopChange)
		window.addEventListener('resize', onResize, { passive: true })
		navLinks.forEach((link) => link.addEventListener('click', closeMenu))

		window.addEventListener(
			'pagehide',
			() => {
				lockBody(false)
				toggleBtn?.removeEventListener('click', onToggle)
				document.removeEventListener('keydown', onKeydown)
				desktopMq.removeEventListener('change', onDesktopChange)
				window.removeEventListener('resize', onResize)
				navLinks.forEach((link) => link.removeEventListener('click', closeMenu))
				timeline.kill()
			},
			{ once: true },
		)
	})()
</script>
