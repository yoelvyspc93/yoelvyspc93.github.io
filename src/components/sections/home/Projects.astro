---
import Tag from '@/shared/Tag.astro'
import CircleButton from '@/ui/CircleButton.astro'
import { Image } from 'astro:assets'
import { getCollection } from 'astro:content'
import 'swiper/css'


const all = await getCollection('projects')

const featured = all
	.filter(({ data }) => Boolean(data.isFavorite))
	.sort((a, b) => Number(a.data.id) - Number(b.data.id))
---

<section
	id="projects"
	class="relative min-h-screen overflow-hidden py-16 sm:py-20 bg-surface-soft"
	aria-labelledby="projects-title"
>
	<div class="absolute inset-0 bg-texture"></div>

	<div class="relative mx-auto max-w-7xl px-4">
		<header class="text-center">
			<h2 id="projects-title">{featured.length} Latest <span>Projects</span></h2>
		</header>

		<div class="mt-20 sm:mt-12">
			<div
				class="swiper select-none"
				data-projects-swiper
				aria-roledescription="carousel"
				aria-label="Featured projects"
			>
				<div class="swiper-wrapper h-auto max-h-[500px]">
					{
						featured.map((entry, idx) => {
							const p = entry.data

							return (
								<div class="swiper-slide" aria-roledescription="slide" aria-label={`Project ${idx + 1} of ${featured.length}`}>
									<article class="grid items-center gap-10 lg:grid-cols-2">
										<!-- Copy -->
										<div class="order-2 lg:order-1 max-w-[440px] flex flex-col gap-10">
											<h3 data-swiper-parallax="-100">{p.title}</h3>

											<p class="max-w-xl text-pretty" data-swiper-parallax="-150">
												{p.shortDescription}
											</p>

											{p.techStack?.length ? (
												<ul
													class="flex flex-wrap gap-2"
													aria-label="Tech stack"
													data-swiper-parallax="-200"
												>
													{p.techStack.map((tech, index) => (
														<li data-swiper-parallax={-20 * (index + 1)}>
															<Tag>{tech}</Tag>
														</li>
													))}
												</ul>
											) : null}
										</div>

										<div class="order-1 lg:order-2">
											<figure class="relative mx-auto w-[500px] h-[400px]" >
												{p.imageUrl.map((image, index) => (
													<Image
														src={image}
														alt={`${p.title} project preview`}
														class="absolute inset-0 w-[500px] h-[400px]"
														loading="lazy"
														decoding="async"
														width={500}
														height={400}
														data-swiper-parallax={-1 * (100 * index + 1)}
													/>
												))}
											</figure>
										</div>
									</article>
								</div>
							)
						})
					}
				</div>
			</div>

			<!-- Controls -->
			<div class="mt-20 flex items-center justify-center gap-6 z-10">
				<button
					type="button"
					class="group inline-flex items-center justify-center rounded-full rotate-180"
					data-projects-prev
					aria-label="Previous project"
				>
					<CircleButton />
				</button>

				<div
					class="projects-pagination flex items-center gap-3"
					data-projects-pagination
					aria-label="Choose project"
				/>

				<button
					type="button"
					class="group inline-flex items-center justify-center rounded-full"
					data-projects-next
					aria-label="Next project"
				>
					<CircleButton />
				</button>
			</div>
		</div>
	</div>

</section>


<style>
	.projects-pagination :global(.swiper-pagination-bullet) {
		opacity: 1;
		transition: transform 200ms ease, opacity 200ms ease;
	}
	.projects-pagination :global(.swiper-pagination-bullet:focus-visible) {
		transform: scale(1.5) !important;
		outline: 2px solid oklch(0.60 0.17 276);
		outline-offset: 4px;
		border-radius: 9999px;
	}
</style>

<script>
	import Swiper from 'swiper'
	import { Navigation, Pagination, Parallax, A11y } from 'swiper/modules'

	const root = document.querySelector('[data-projects-swiper]')
	const buttonPrev = document.querySelector('[data-projects-prev]')
	const buttonNext = document.querySelector('[data-projects-next]')
	const pagination = document.querySelector('[data-projects-pagination]')

	const prefersReducedMotion = window.matchMedia?.('(prefers-reduced-motion: reduce)')?.matches ?? false

	let swiper: Swiper | undefined;

	const mount = () => {
		if (swiper || !root || !buttonPrev || !buttonNext || !pagination) return

		swiper = new Swiper(root as HTMLElement, {
			modules: [Navigation, Pagination, Parallax, A11y],
			slidesPerView: 1,
			spaceBetween: 0,
			speed: prefersReducedMotion ? 0 : 1500,
			grabCursor: true,
			parallax: !prefersReducedMotion,
			watchSlidesProgress: true,
			a11y: {
				enabled: true,
			},
			navigation: {
				prevEl: buttonPrev as HTMLElement,
				nextEl: buttonNext as HTMLElement,
				disabledClass: 'opacity-40 pointer-events-none',
			},
			pagination: {
				el: pagination as HTMLElement,
				clickable: true,
				bulletElement: 'button',
				bulletClass: 'dot dot-md dot-neutral',
				bulletActiveClass: '!bg-primary',
				renderBullet: (index, className) =>
					`<button type="button" class="${className}" aria-label="Go to project ${index + 1}"></button>`,
			},
		})
	}

	const unmount = () => {
		if (!swiper) return
		swiper.destroy(true, true)
		swiper = undefined
	}

	mount()

	// Astro view transitions / navigation safety
	document.addEventListener('astro:before-swap', unmount)
	document.addEventListener('pagehide', unmount)
</script>
