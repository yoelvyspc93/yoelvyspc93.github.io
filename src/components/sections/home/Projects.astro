---
import ProjectItem from '@/shared/ProjectItem.astro'
import CircleButton from '@/ui/CircleButton.astro'
import { getCollection } from 'astro:content'
import 'swiper/css'

type Props = {
	content: {
		title: string
		accent: string
	}
	labels: {
		ariaLabel: string
		paginationLabel: string
		prevLabel: string
		nextLabel: string
		bulletLabel: string
	}
}

const { content, labels } = Astro.props

const all = await getCollection('projects')

const featured = all
	.filter(({ data }) => Boolean(data.favorite))
	.sort((a, b) => Number(a.data.id) - Number(b.data.id))

const { title, accent } = content
const { ariaLabel, paginationLabel, prevLabel, nextLabel, bulletLabel } = labels
---

<section
	id="projects"
	class="section-container py-16 sm:py-20 bg-surface-soft"
	aria-labelledby="projects-title"
>
	<div aria-hidden="true" class="absolute inset-0 bg-texture"></div>

	<div class="relative mx-auto max-w-7xl px-4">
		<header class="text-center">
			<h2 id="projects-title">
				{featured.length} {title} <span>{accent}</span>
			</h2>
		</header>

		<div class="mt-20 sm:mt-12">
			<div
				class="swiper select-none"
				data-projects-swiper
				aria-roledescription="carousel"
				aria-label={ariaLabel}
			>
				<ul class="swiper-wrapper h-auto max-h-[500px]" role="list">
					{
						featured.map((entry, idx) => {
							const { title, overview, images, technologies } = entry.data

							return (
								<li
									class="swiper-slide"
									aria-roledescription="slide"
									aria-label={`${idx + 1}/${featured.length}`}
								>
									<ProjectItem
										title={title}
										overview={overview}
										images={images}
										technologies={technologies}
									/>
								</li>
							)
						})
					}
				</ul>
			</div>

			<!-- Controls -->
			<nav
				class="mt-20 flex items-center justify-center gap-6 z-10"
				aria-label={paginationLabel}
			>
				<button
					type="button"
					class="group inline-flex items-center justify-center rounded-full rotate-180"
					data-projects-prev
					aria-label={prevLabel}
				>
					<CircleButton />
				</button>

				<div
					class="projects-pagination flex items-center gap-3"
					data-projects-pagination
					aria-label={paginationLabel}
				>
				</div>

				<button
					type="button"
					class="group inline-flex items-center justify-center rounded-full"
					data-projects-next
					aria-label={nextLabel}
				>
					<CircleButton />
				</button>
			</nav>
		</div>
	</div>
</section>

<!-- <style>
	.projects-pagination :global(.swiper-pagination-bullet) {
		opacity: 1;
		transition:
			transform 200ms ease,
			opacity 200ms ease;
	}
	.projects-pagination :global(.swiper-pagination-bullet:focus-visible) {
		transform: scale(1.5) !important;
		outline: 2px solid oklch(0.6 0.17 276);
		outline-offset: 4px;
		border-radius: 9999px;
	}
</style> -->

<script define:vars={{ bulletLabel }}>
	import Swiper from 'swiper'
	import { Navigation, Pagination, Parallax, A11y } from 'swiper/modules'

	const root = document.querySelector('[data-projects-swiper]')
	const buttonPrev = document.querySelector('[data-projects-prev]')
	const buttonNext = document.querySelector('[data-projects-next]')
	const pagination = document.querySelector('[data-projects-pagination]')

	const prefersReducedMotion =
		window.matchMedia?.('(prefers-reduced-motion: reduce)')?.matches ?? false

	let swiper: Swiper | undefined

	const mount = () => {
		if (swiper || !root || !buttonPrev || !buttonNext || !pagination) return

		swiper = new Swiper(root as HTMLElement, {
			modules: [Navigation, Pagination, Parallax, A11y],
			slidesPerView: 1,
			spaceBetween: 0,
			speed: prefersReducedMotion ? 0 : 1500,
			grabCursor: true,
			parallax: !prefersReducedMotion,
			watchSlidesProgress: true,
			a11y: {
				enabled: true,
			},
			navigation: {
				prevEl: buttonPrev as HTMLElement,
				nextEl: buttonNext as HTMLElement,
				disabledClass: 'opacity-40 pointer-events-none',
			},
			pagination: {
				el: pagination as HTMLElement,
				clickable: true,
				bulletElement: 'button',
				bulletClass: 'dot dot-md dot-neutral',
				bulletActiveClass: '!bg-primary',
				renderBullet: (index, className) =>
					`<button type="button" class="${className}" aria-label="${bulletLabel} ${index + 1}"></button>`,
			},
		})
	}

	const unmount = () => {
		if (!swiper) return
		swiper.destroy(true, true)
		swiper = undefined
	}

	mount()

	// Astro view transitions / navigation safety
	document.addEventListener('astro:before-swap', unmount)
	document.addEventListener('pagehide', unmount)
</script>
