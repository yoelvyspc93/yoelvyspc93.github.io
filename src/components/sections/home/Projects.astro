---
import ProjectItem from '@/shared/ProjectItem.astro'
import CircleButton from '@/ui/CircleButton.astro'
import { getCollection } from 'astro:content'
import 'swiper/css'

type Props = {
	content: {
		title: string
		accent: string
	}
}

const { content } = Astro.props

const all = await getCollection('projects')

const featured = all
	.filter(({ data }) => Boolean(data.favorite))
	.sort((a, b) => Number(a.data.id) - Number(b.data.id))

const { title, accent } = content
const ariaLabel = 'Featured projects'
const paginationLabel = 'Choose project'
const prevLabel = 'Previous project'
const nextLabel = 'Next project'
const bulletLabel = 'Go to project'
---

<section
	id="projects"
	class="section-container bg-surface-soft px-4 py-14 sm:py-16 md:py-20"
	data-projects-section
	aria-labelledby="projects-title"
>
	<div aria-hidden="true" class="absolute inset-0 bg-texture"></div>

	<div
		class="relative mx-auto max-w-[100vw] md:max-w-[560px] lg:max-w-7xl px-4"
	>
		<header class="text-center">
			<h2 id="projects-title">
				{featured.length}
				{title}{' '}
				<span>{accent}</span>
			</h2>
		</header>

		<div class="mt-10 sm:mt-12 md:mt-14">
			<div
				class="swiper select-none"
				data-projects-swiper
				data-bullet-label={bulletLabel}
				aria-label={ariaLabel}
			>
				<div class="swiper-wrapper h-auto">
					{
						featured.map((entry, idx) => {
							const { title, overview, images, technologies } = entry.data

							return (
								<div
									class="swiper-slide"
									aria-label={`${idx + 1} / ${featured.length}`}
								>
									<ProjectItem
										title={title}
										overview={overview}
										images={images}
										technologies={technologies}
									/>
								</div>
							)
						})
					}
				</div>
			</div>

			<!-- Controls -->
			<nav
				class="z-10 mt-10 flex items-center justify-center gap-4 sm:mt-12 sm:gap-6 md:mt-14"
				aria-label={paginationLabel}
			>
				<button
					type="button"
					class="group inline-flex items-center justify-center rounded-full rotate-180"
					data-projects-prev
					aria-label={prevLabel}
				>
					<CircleButton />
				</button>

				<div
					class="projects-pagination flex items-center gap-3"
					data-projects-pagination
					aria-label={paginationLabel}
				>
				</div>

				<button
					type="button"
					class="group inline-flex items-center justify-center rounded-full"
					data-projects-next
					aria-label={nextLabel}
				>
					<CircleButton />
				</button>
			</nav>
		</div>
	</div>
</section>

<script>
	import Swiper from 'swiper'
	import { Navigation, Pagination, Parallax, A11y } from 'swiper/modules'

	const prefersReducedMotion =
		window.matchMedia?.('(prefers-reduced-motion: reduce)')?.matches ?? false

	let swiper: Swiper | undefined
	let currentRoot: HTMLElement | null = null

	const getElements = () => {
		const section = document.querySelector('[data-projects-section]')
		if (!(section instanceof HTMLElement)) return null

		const root = section.querySelector('[data-projects-swiper]')
		const buttonPrev = section.querySelector('[data-projects-prev]')
		const buttonNext = section.querySelector('[data-projects-next]')
		const pagination = section.querySelector('[data-projects-pagination]')

		if (
			!(root instanceof HTMLElement) ||
			!(buttonPrev instanceof HTMLElement) ||
			!(buttonNext instanceof HTMLElement) ||
			!(pagination instanceof HTMLElement)
		) {
			return null
		}

		return {
			root,
			buttonPrev,
			buttonNext,
			pagination,
			bulletLabel: root.dataset.bulletLabel ?? 'Go to project',
		}
	}

	const mount = () => {
		const elements = getElements()
		if (!elements) {
			unmount()
			return
		}

		const { root, buttonPrev, buttonNext, pagination, bulletLabel } = elements

		if (swiper && currentRoot === root) return
		unmount()
		currentRoot = root

		swiper = new Swiper(root, {
			modules: [Navigation, Pagination, Parallax, A11y],
			slidesPerView: 1,
			spaceBetween: 0,
			speed: prefersReducedMotion ? 0 : 1500,
			grabCursor: true,
			parallax: !prefersReducedMotion,
			watchSlidesProgress: true,
			a11y: {
				enabled: true,
			},
			navigation: {
				prevEl: buttonPrev,
				nextEl: buttonNext,
				disabledClass: 'opacity-40 pointer-events-none',
			},
			pagination: {
				el: pagination,
				clickable: true,
				bulletElement: 'button',
				bulletClass: 'dot dot-md dot-neutral',
				bulletActiveClass: '!bg-primary',
				renderBullet: (index, className) =>
					`<button type="button" class="${className}" aria-label="${bulletLabel} ${index + 1}"></button>`,
			},
		})
	}

	const unmount = () => {
		if (!swiper) return
		swiper.destroy(true, true)
		swiper = undefined
		currentRoot = null
	}

	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', mount, { once: true })
	} else {
		mount()
	}

	// Astro view transitions / navigation safety
	document.addEventListener('astro:page-load', mount)
	document.addEventListener('astro:before-swap', unmount)
	window.addEventListener('pagehide', unmount)
</script>
