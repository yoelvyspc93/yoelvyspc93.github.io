---
import Button from '@/ui/Button.astro'
import InputField from '@/ui/InputField.astro'
import TextAreaField from '@/ui/TextAreaField.astro'
type Props = {
		content: {
			title: string
			body: string[]
			form: {
				errors: {
					emailRequired: string
					emailInvalid: string
					messageRequired: string
				}
			}
		}
		meta: {
			socials: { platform: string; url: string }[]
			form: { to: string; subject: string }
		}
	}

const { content, meta } = Astro.props
const { form } = content
const { to: TO, subject: SUBJECT } = meta.form
const { errors } = form
const formAriaLabel = 'Contact form'
const socialsLabel = 'Social links'
const emailLabel = 'Email'
const emailPlaceholder = 'Your email'
const messageLabel = 'Message'
const messagePlaceholders = [
	'Write your message here...',
	'Tell me about your project',
	'How can I help you?',
	'Share your idea or request',
]
const submitLabel = 'Send Message'
---

<section
	id="contact"
	aria-labelledby="contact-title"
	class="section-container px-4 pb-4"
>
	<div
		class="mx-auto flex w-full max-w-[1200px] flex-col items-center gap-12 px-4 lg:flex-row lg:gap-20"
	>
		<article class="w-full flex-1 max-w-[492px] md:max-w-full">
			<header>
				<h2
					id="contact-title"
					class="mb-4 font-display text-heading-2 font-bold"
				>
					{content.title}
				</h2>
			</header>

			<div class="mb-10 flex max-w-[600px] flex-col gap-4 font-sans text-large leading-normal text-pretty text-white">
				{content.body.map((paragraph) => (
					<p>{paragraph}</p>
				))}
			</div>

			<nav aria-label={socialsLabel}>
				<ul class="flex list-none flex-row gap-3 p-0">
					{
						meta.socials.map((sm) => (
							<li>
								<a
									aria-label={sm.platform}
									href={sm.url}
									target="_blank"
									rel="noopener noreferrer"
									class="h-11 w-auto rounded-lg bg-dark-gray p-2.5 flex items-center justify-center"
								>
									{sm.platform}
								</a>
							</li>
						))
					}
				</ul>
			</nav>
		</article>

		<form
			id="contact-form"
			class="flex w-full flex-1 max-w-[492px] flex-col gap-[30px] rounded-[24px] bg-dark-gray px-[30px] py-10 md:max-w-full"
			aria-label={formAriaLabel}
			novalidate
		>
			<fieldset class="flex flex-col gap-[30px] border-0 p-0 m-0">
				<legend class="sr-only">{formAriaLabel}</legend>
				<div>
					<InputField
						label={emailLabel}
						type="email"
						id="email"
						placeholders={[emailPlaceholder]}
						required={true}
						ariaDescribedby="email-error"
					/>
				</div>

				<div>
					<TextAreaField
						label={messageLabel}
						id="message"
						placeholders={messagePlaceholders}
						required={true}
						ariaDescribedby="message-error"
					/>
				</div>

				<div class="mt-4 flex w-full justify-end">
					<Button type="submit" aria-label={submitLabel}>
						{submitLabel}
					</Button>
				</div>
			</fieldset>
		</form>
	</div>
</section>

<script define:vars={{ TO, SUBJECT, errors }}>
	const form = document.getElementById('contact-form')
	const emailInput = document.getElementById('email')
	const messageInput = document.getElementById('message')
	const emailError = document.getElementById('email-error')
	const messageError = document.getElementById('message-error')

	const validateEmail = (email) => {
		const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/
		return emailRegex.test(email)
	}

	const showError = (element, message) => {
		if (element) {
			element.textContent = message
			element.classList.remove('sr-only')
		}
	}

	const hideError = (element) => {
		if (element) {
			element.textContent = ''
			element.classList.add('sr-only')
		}
	}

	form?.addEventListener('submit', (e) => {
		e.preventDefault()

		const email = (emailInput?.value || '').trim()
		const message = (messageInput?.value || '').trim()

		let isValid = true

		// Validate email
		if (!email) {
			showError(emailError, errors.emailRequired)
			emailInput?.setAttribute('aria-invalid', 'true')
			isValid = false
		} else if (!validateEmail(email)) {
			showError(emailError, errors.emailInvalid)
			emailInput?.setAttribute('aria-invalid', 'true')
			isValid = false
		} else {
			hideError(emailError)
			emailInput?.setAttribute('aria-invalid', 'false')
		}

		// Validate message
		if (!message) {
			showError(messageError, errors.messageRequired)
			messageInput?.setAttribute('aria-invalid', 'true')
			isValid = false
		} else {
			hideError(messageError)
			messageInput?.setAttribute('aria-invalid', 'false')
		}

		if (!isValid) {
			// Focus first invalid field
			if (!email || !validateEmail(email)) {
				emailInput?.focus()
			} else if (!message) {
				messageInput?.focus()
			}
			return
		}

		const encodedTo = encodeURIComponent(TO)
		const encodedSubject = encodeURIComponent(SUBJECT)
		const body = `From: ${email}\n\n${message}`
		const encodedBody = encodeURIComponent(body)

		globalThis.location.href = `mailto:${encodedTo}?subject=${encodedSubject}&body=${encodedBody}`
	})

	// Clear errors on input
	emailInput?.addEventListener('input', () => {
		if (emailInput.value.trim()) {
			hideError(emailError)
			emailInput.setAttribute('aria-invalid', 'false')
		}
	})

	messageInput?.addEventListener('input', () => {
		if (messageInput.value.trim()) {
			hideError(messageError)
			messageInput.setAttribute('aria-invalid', 'false')
		}
	})
</script>
